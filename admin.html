<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teno in Nach — Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    body, html { height:100%; margin:0; font-family:'Segoe UI',sans-serif; }
    .d-flex { display:flex; height:100%; }
    #sidebar { width:250px; background:#343a40; color:#fff; display:flex; flex-direction:column; padding:1rem; }
    #sidebar h4 { margin-bottom:2rem; text-align:center; font-weight:bold; }
    #sidebar .nav-link { color:#ced4da; margin-bottom:.5rem; padding:.5rem 1rem; border-radius:.25rem; transition:background .2s; }
    #sidebar .nav-link.active, #sidebar .nav-link:hover { background:#495057; color:#fff; }
    #sidebar .btn-logout { margin-top:auto; background:#ff416c; border:none; color:#fff; padding:.5rem; border-radius:.25rem; }
    #sidebar .btn-logout:hover { background:#ff4b2b; }
    #content { flex-grow:1; background:#f8f9fa; padding:2rem; overflow-y:auto; }

    .card-draggable { cursor:move; }
    .card-draggable img { width:100%; height:150px; object-fit:cover; }
    .card-actions { position:absolute; top:.5rem; right:.5rem; }
    .card-disabled { opacity:.5; }
    .add-tile {
      display:flex; align-items:center; justify-content:center;
      font-size:2rem; color:#aaa; cursor:pointer;
      height:100%; min-height:200px;
      border:2px dashed #ddd; border-radius:.5rem;
      transition:background .2s;
    }
    .add-tile:hover { background:#e9ecef; }
    .stock-input { width:60px; }
  </style>
</head>
<body>

  <div class="d-flex">
    <nav id="sidebar">
      <h4>Teno in Nach</h4>
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link active" href="admin.html">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="users.html">Users</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Merch</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Transactions</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Tabulation</a></li>
      </ul>
      <button class="btn btn-logout">Logout</button>
    </nav>

    <div id="content">
      <!-- Announcements -->
      <h2 class="mb-3">Announcements</h2>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5" id="announcement-container"></div>
      <!-- Schedule -->
      <h2 class="mb-3">Schedule</h2>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5" id="schedule-container"></div>
      <!-- Events -->
      <h2 class="mb-3">Events</h2>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5" id="events-container"></div>
      <!-- Merch -->
      <h2 class="mb-3">Merch</h2>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5" id="merch-container"></div>
      <!-- Highlights -->
      <h2 class="mb-3">Highlights</h2>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="highlight-container"></div>
    </div>
  </div>

  <!-- Shared Modal for Add/Edit -->
  <div class="modal fade" id="cardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cardModalLabel">Add</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="card-form">
            <input type="hidden" id="card-id">
            <input type="hidden" id="card-type">

            <!-- Photo (all types) -->
            <div class="mb-3 text-center">
              <img id="card-preview"
                   src="https://via.placeholder.com/300x150"
                   class="rounded mb-2"
                   style="width:100%;height:150px;object-fit:cover;"
                   alt="Preview">
              <input type="file" id="card-photo" accept="image/*" class="form-control form-control-sm">
            </div>

            <!-- Announcement fields -->
            <div id="header-group" class="mb-3">
              <label class="form-label">Header</label>
              <input type="text" id="card-header" class="form-control">
            </div>
            <div id="desc-group" class="mb-3">
              <label class="form-label">Description</label>
              <textarea id="card-desc" class="form-control" rows="2"></textarea>
            </div>

            <!-- Merch fields -->
            <div id="merch-name-group" class="mb-3">
              <label class="form-label">Product Name</label>
              <input type="text" id="merch-name" class="form-control">
            </div>
            <div id="merch-price-group" class="mb-3">
              <label class="form-label">Price</label>
              <input type="number" id="merch-price" class="form-control" step="0.01">
            </div>
            <div id="merch-stock-group" class="mb-3">
              <label class="form-label">Stock by Size</label>
              <div class="d-flex gap-2 flex-wrap">
                <div><label class="d-block mb-1">S</label><input type="number" id="stock-S" class="form-control stock-input"></div>
                <div><label class="d-block mb-1">M</label><input type="number" id="stock-M" class="form-control stock-input"></div>
                <div><label class="d-block mb-1">L</label><input type="number" id="stock-L" class="form-control stock-input"></div>
                <div><label class="d-block mb-1">XL</label><input type="number" id="stock-XL" class="form-control stock-input"></div>
              </div>
            </div>

          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="save-card-btn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap + Logic -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const modalEl = document.getElementById('cardModal'),
          modal   = new bootstrap.Modal(modalEl);

    let announcements = [], schedule = [], events = [], merch = [], highlights = [];

    function getStore(type) {
      return { announcement: announcements,
               schedule: schedule,
               events: events,
               merch: merch,
               highlight: highlights }[type];
    }
    function getContainer(type) {
      return document.getElementById(type + '-container');
    }

    function render(type) {
      const store = getStore(type),
            cont  = getContainer(type);
      cont.innerHTML = '';

      store.forEach((c, idx) => {
        const col = document.createElement('div');
        col.className     = 'col';
        col.draggable     = true;
        col.dataset.index = idx;
        col.dataset.type  = type;

        const card = document.createElement('div');
        card.className = `position-relative card bg-white rounded-lg shadow-sm p-0 card-draggable`;

        // Image only
        const img = document.createElement('img');
        img.src = c.photo;
        card.append(img);

        // Edit button
        const act = document.createElement('div');
        act.className = 'card-actions';
        act.innerHTML = `<button class="btn btn-sm btn-light"><i class="bi bi-pencil-fill"></i></button>`;
        act.firstChild.addEventListener('click', e => {
          e.stopPropagation(); openModal(type, c);
        });
        card.append(act);

        // Body: only for announcement and merch
        if (type === 'announcement') {
          const body = document.createElement('div');
          body.className = 'p-3 text-center';
          body.innerHTML = `
            <h5 class="fw-bold mb-1">${c.header}</h5>
            <p class="text-muted mb-2">${c.desc}</p>
            <button class="btn btn-sm btn-${c.enabled?'warning':'success'} toggle-btn">
              ${c.enabled?'Disable':'Enable'}
            </button>
          `;
          body.querySelector('.toggle-btn').addEventListener('click', e => {
            e.stopPropagation(); c.enabled = !c.enabled; render(type);
          });
          card.append(body);
        }
        if (type === 'merch') {
          const body = document.createElement('div');
          body.className = 'p-3 text-center';
          body.innerHTML = `
            <h5 class="fw-bold mb-1">${c.name}</h5>
            <p class="text-muted mb-1">$${c.price.toFixed(2)}</p>
            <div class="d-flex justify-content-center gap-1 flex-wrap">
              <span class="badge bg-secondary">S ${c.stock.S}</span>
              <span class="badge bg-secondary">M ${c.stock.M}</span>
              <span class="badge bg-secondary">L ${c.stock.L}</span>
              <span class="badge bg-secondary">XL ${c.stock.XL}</span>
            </div>
          `;
          card.append(body);
        }

        // Click & drag
        card.addEventListener('click', () => openModal(type, c));
        col.addEventListener('dragstart', onDragStart);
        col.addEventListener('dragover', e => e.preventDefault());
        col.addEventListener('drop', onDrop);

        col.append(card);
        cont.append(col);
      });

      // Add tile
      const addCol = document.createElement('div');
      addCol.className = 'col';
      addCol.innerHTML = `<div class="add-tile"><span>＋</span></div>`;
      addCol.addEventListener('click', () => openModal(type));
      cont.append(addCol);
    }

    let dragIdx = null, dragType = null;
    function onDragStart(e) {
      dragIdx  = +this.dataset.index;
      dragType = this.dataset.type;
      e.dataTransfer.effectAllowed = 'move';
    }
    function onDrop(e) {
      e.preventDefault();
      const dst   = +this.dataset.index,
            store = getStore(dragType),
            [m]   = store.splice(dragIdx,1);
      store.splice(dst,0,m);
      render(dragType);
    }

    function openModal(type, card=null) {
      document.getElementById('card-type').value = type;
      document.getElementById('card-id').value   = card?.id || '';
      document.getElementById('card-preview').src = card?.photo || 'https://via.placeholder.com/300x150';

      // show/hide fields
      document.getElementById('header-group').style.display      = type==='announcement'? 'block':'none';
      document.getElementById('desc-group').style.display        = type==='announcement'? 'block':'none';
      document.getElementById('merch-name-group').style.display  = type==='merch'?      'block':'none';
      document.getElementById('merch-price-group').style.display = type==='merch'?      'block':'none';
      document.getElementById('merch-stock-group').style.display = type==='merch'?      'block':'none';

      // populate
      document.getElementById('card-header').value = card?.header||'';
      document.getElementById('card-desc').value   = card?.desc  ||'';
      document.getElementById('merch-name').value  = card?.name  ||'';
      document.getElementById('merch-price').value = card?.price ||'';
      ['S','M','L','XL'].forEach(sz => {
        document.getElementById(`stock-${sz}`).value = card?.stock?.[sz] ?? 0;
      });

      document.getElementById('cardModalLabel').innerText = card? 'Edit':'Add';
      modal.show();
    }

    document.getElementById('card-photo').onchange = e => {
      const f = e.target.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = () => document.getElementById('card-preview').src = r.result;
      r.readAsDataURL(f);
    };

    document.getElementById('save-card-btn').onclick = () => {
      const type   = document.getElementById('card-type').value,
            store  = getStore(type),
            id     = document.getElementById('card-id').value || Date.now().toString(),
            photo  = document.getElementById('card-preview').src;
      let record = { id, photo, enabled:true };

      if (type==='announcement') {
        record.header = document.getElementById('card-header').value;
        record.desc   = document.getElementById('card-desc').value;
      }
      if (type==='merch') {
        record.name  = document.getElementById('merch-name').value;
        record.price = parseFloat(document.getElementById('merch-price').value)||0;
        record.stock = {};
        ['S','M','L','XL'].forEach(sz=>{
          record.stock[sz] = parseInt(document.getElementById(`stock-${sz}`).value)||0;
        });
      }

      const idx = store.findIndex(c=>c.id===id);
      if (idx>-1) store[idx] = record; else store.push(record);

      modal.hide();
      render(type);
    };

    ['announcement','schedule','events','merch','highlight'].forEach(render);
  </script>
</body>
</html>
